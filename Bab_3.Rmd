---
output: pdf_document
header-includes:
  \usepackage{amsmath}
  \usepackage{pdflscape}
  \usepackage{enumitem}
---

```{r set-awal,echo=FALSE,include=TRUE,message=FALSE}

library(ggplot2)

# jenis data debit atau curah hujan?
dbt <- "Debit"
hjn <- "Hujan"
dbt_title <- expression("Debit Harian"~(m^3/dtk))
dbt_labs <- expression("Debit"~(m^3/dtk))
hjn_title <- "Nilai Curah Hujan (mm)"
hjn_labs <- "Curah Hujan (mm)"

jenis_data <- hjn        # rubah sesuai jenis data yang ada, hujan atau debit?
judul_data <- hjn_title  # rubah sesuai jenis data yang ada, hujan atau debit?
judul_label <- hjn_labs  # rubah sesuai jenis data yang ada, hujan atau debit?


nama_pos <- "Stasiun Hujan Cisomang"

data <- read.csv("data_and_code/sta_cisomang.csv") #input data dari excel
names(data) <- c("Tanggal",jenis_data) # rubah nama
data <- subset(data,data[,2] != "-") 
data <- data[,1:2]

data$Tanggal <- as.Date(data[,1],format="%d-%b-%y") #cek format tanggal dari data original.
data[,2] <- as.numeric(as.character(data[,2])) #JANGAN LUPA as.character.

nama_pos <- "Stasiun Hujan Cisomang"

index_max <- data[,2] == max(data[,2])

kejadian_max <- data[index_max,]
tanggal_max <- kejadian_max[,1]
nilai_max <- max(data[,2])

```


# Analisa Hidrologi

## *Catchment Area*

Untuk dapat menghitung debit banjir dan debit andalan, diperlukan 2 (dua) inputan data utama. Input yang pertama adalah karakteristik dari catchment area yang ditinjau seperti luasan, panjang saluran, dan kemiringan saluran. Kemudian input kedua yang diperlukan adalah curah hujan rencana.  
Untuk data karakteristik sub DAS diperoleh dari deliniasi peta rupa bumi Indonesia (RBI) skala 1:25.000 yang bersumber dari Badan Informasi Geospasial dan validasi di lapangan. Hasil deliniasi pada ketiga lokasi yang ditinjau ditampilkan pada Gambar \ref{lokasidantabel}. Sedangkan zoom-in dari masing-masing catchment area dapat dilihat pada Gambar \ref{ca_bji} hingga Gambar \ref{ca_baranangsiang}. 

![Catchment Area Saluran Drainase Yang Ditinjau. \label{lokasidantabel}](gambar\lokasi_pekerjaan_plus_tabel.png)

<!-- <img src="gambar\lokasi_pekerjaan_plus_tabel.png" width="300" height="150" center> -->

![Catchment BJI. \label{ca_bji}](gambar\ca_bji.png)

![Catchment Kemuning. \label{ca_kemuning}](gambar\ca_kemuning.png)

![Catchment Baranangsiang. \label{ca_baranangsiang}](gambar\ca_baranangsiang.png)



## Data Stasiun Hujan

Di sekitar area sub DAS terdapat 1 (satu) stasiun pengamat yang terdekat, yaitu Stasiun Cisomang. Berikut ditampilkan posisi stasiun hujan terhadap sub DAS serta tabel koordinat data hujan yang akan digunakan.

![*Overlay* Lokasi Pos Hujan Terhadap *Catchment Area*. \label{peta_pos_hujan}](gambar\peta_pos_hujan.png)

```{r, include=TRUE, echo=FALSE, message=FALSE}
library(readxl)
library(dplyr)
library(kableExtra)

Koordinat_Pos_Hujan <- read_excel("data_and_code/Koordinat_Pos_Hujan.xlsx", 
    col_types = c("numeric", "text", "text", 
        "text", "text", "skip", "skip"))

kable(Koordinat_Pos_Hujan, "latex", escape=FALSE, booktabs=TRUE, linesep="", caption="Koordinat Pos Hujan.\\label{tbl_pos_hujan}") %>%
    kable_styling(latex_options=c("HOLD_position"))
```

Ketersediaan data untuk Stasiun Cisomang adalah curah hujan harian selama 24 tahun yaitu dari tahun 1995 sampai dengan tahun 2018. Hujan maksimum yang terjadi di `r nama_pos` adalah `r nilai_max` mm pada `r tanggal_max`. Rekapitulasi curah hujan yang akan digunakan ditampilkan pada Tabel \ref{hujan-max} dan Gambar \ref{data-hujan}.

```{r data-hujan, fig.cap="Data Stasiun Hujan \\label{data-hujan}",echo=FALSE}


g <- ggplot(data,aes(x=Tanggal, y=Hujan))+geom_line(col="blue3") + 
  labs(title=judul_data,subtitle = nama_pos,x = "Waktu",y=judul_label) +
  theme_update(plot.title=element_text(hjust=0.5))+
  theme_update(plot.subtitle=element_text(hjust=0.5))+
  theme_update(axis.title.y=element_text(angle=90))+
  theme(plot.background = element_rect(colour = "black", size = 0.5))

index_max <- data[,2] == max(data[,2])
index_min <- data[,2] == min(data[,2])
max_min_plot <- ggplot(data,aes(x=Tanggal, y=data[,2]),label=jenis_data)+geom_line(color="blue3") + 
  labs(title=judul_data,subtitle = nama_pos,x = "Waktu",y=judul_label) +
  geom_point(data=data[index_max,],aes(Tanggal,Hujan,color="MAX"))+
  geom_point(data=data[index_min,],aes(Tanggal,Hujan,color="MIN"))+
  geom_text(aes(label=ifelse(Hujan==max(Hujan),as.character(Hujan),'')),hjust=-0.5,vjust=0.5)

kejadian_max <- data[index_max,]
tanggal_max <- kejadian_max[,1]
nilai_max <- max(data[,2])

max_min_plot + theme(plot.background = element_rect(colour = "black", size = 0.5))

```


```{r matrixplot_hujan, echo=FALSE, fig.cap="Matrixplot Jumlah Hujan Bulanan \\label{matrixplot-hujan}", fig.height=5, fig.width=8, message=FALSE, include=TRUE}

library(hydroTSM)
# buat matrixplot
zoo_rr_data <- zoo(data[,2],data$Tanggal)
#sapply(zoo_rr_data, class)

# extract total monthly precipitation
bulanan_zoo_rr_data <- daily2monthly(zoo_rr_data, FUN=sum, na.rm = T)
bulanan_rata2_zoo <- daily2monthly(zoo_rr_data, FUN=mean, na.rm = T)

# buat matrix hujan bulanan

mat <- matrix(bulanan_zoo_rr_data, ncol=12, byrow = T)
mat_rata2 <- matrix(bulanan_rata2_zoo, ncol=12, byrow = T)

colnames(mat) <- month.abb
rownames(mat) <- unique(format(time(bulanan_zoo_rr_data), "%Y"))

colnames(mat_rata2) <- month.abb
rownames(mat_rata2) <- unique(format(time(bulanan_rata2_zoo), "%Y"))

library(lattice)
require(lattice)

# matrixplot untuk jumlah curah hujan
print(matrixplot(mat, ColorRamp = "Precipitation",
                 main="Jumlah Curah Hujan Bulanan (mm)")) #ganti judul kalau data hujan.
```




```{r hujan-harian-rata2, fig.cap="Hujan Harian Rata-Rata  \\label{hujan-harian-rata2}",echo=FALSE,message=FALSE}
library(lubridate)

# tambah kolom tahun, bulan, dan hari
data$DOY <- as.numeric(yday(data$Tanggal))
data$Tahun <- as.numeric(format(data$Tanggal,"%Y"))
data$Bulan <- as.numeric(format(data$Tanggal,"%m"))

## create mean per day
mean_data <- aggregate(data[jenis_data],list(data$DOY),mean)

## add DOY and YEAR columns
mean_data <- cbind(DOY=seq(1:366),YEAR=2018,mean_data)

# grafik dengan ggplot
# ggplot(mean_data,aes(x=DOY,y=Hujan))+
#   labs(title="Curah Hujan Harian Rata-Rata (mm)",subtitle = nama_pos,x = "Waktu",y=judul_label)+
#   geom_smooth(span=0.3)

# grafik dengan qplot (sama saja dengan ggplot tapi ada node-nodenya)
qplot(x=mean_data$DOY,y=mean_data$Hujan,
      main = c("Curah Hujan Harian Rata-Rata (mm)",judul_data),
      ylab = judul_label,
      xlab = "Waktu (Hari)")+geom_smooth(span=0.3)+theme(plot.background = element_rect(colour = "black", size = 0.5))


```


```{r hujan-max, echo=FALSE, message=FALSE, include=TRUE}
library(ggplot2)
library(dplyr)
library(lubridate)
library(kableExtra)


# cek struktur data
# str(data)

#tambah kolom tahun, bulan, dan hari
data$DOY <- as.numeric(yday(data$Tanggal))
data$Tahun <- as.numeric(format(data$Tanggal,"%Y"))
data$Bulan <- as.numeric(format(data$Tanggal,"%m"))

data_max <- data %>%
  group_by(Tahun) %>% 
  summarise(Hujan_Max = max(Hujan))

kable(data_max,"latex", longtable=T, booktabs=TRUE, linesep="", caption="Data Hujan Maksimum.\\label{hujan-max}") %>% kable_styling(latex_options=c("HOLD_position","repeat_header"))

```


```{r grafik-max, fig.cap="Grafik Hujan Harian Maksimum Tiap Tahun Pengamatan \\label{grafik-max}",echo=FALSE,message=FALSE}
ggplot(data_max,aes(x=Tahun, y=Hujan_Max))+geom_col(col="blue3",fill="cadetblue3") + 
  labs(title="Curah Hujan Maksimum Harian (mm)",subtitle = nama_pos,x = "Waktu",y=judul_label) +
  geom_text(aes(label=Hujan_Max), position=position_dodge(width=0.5), vjust=-0.2,check_overlap = T) +
  theme_update(plot.title=element_text(hjust=0.5))+
  theme_update(plot.subtitle=element_text(hjust=0.5))+
  theme_update(axis.title.y=element_text(angle=90))+
  theme(plot.background = element_rect(colour = "black", size = 0.5))

```

\newpage

## Uji Outlier

Sebelum data hujan dipakai dalam analisa maka diperlukan pemeriksaan terlebih dahulu untuk memastikan bahwa data yang tercatat adalah benar secara statistik. Salah satu metode pemeriksaan yang umum digunakan adalah uji outlier. Pada pemeriksaan adanya outlier, seri data hujan harian maksimum tahunan, baik outlier atas maupun outlier bawah dilakukan dengan metoda yang dikembangkan oleh @Helsel2002. Bila terdapat outlier, maka data outlier harus dipertimbangkan secara teknis sebelum seri data digunakan untuk analisis hidrologi lebih lanjut.
Persamaan frekuensi untuk mendeteksi adanya outlier atas ditampilkan dalam persamaan \ref{eq:uji-outlier}.

\begin{equation}
\label{eq:uji-outlier}
X_H = X_{rerata}+S\times K_n
\end{equation}

dimana:
\begin{itemize}[leftmargin=2.0cm, labelsep=0.5cm]
\item[$X_H$ =] Batas (threshold) dari outlier atas, dalam logaritma
\item[$S$ =] Nilai rata-rata dari data dalam bentuk logaritma
\item[$K_n$ =] Konstanta uji \textit{outlier}, merupakan fungsi dari jumlah data sampel.
\end{itemize}

Persamaan serupa untuk mendeteksi adanya *outlier* bawah adalah:

\begin{equation}
\label{eq:uji-outlier}
X_L = X_{rerata}+S\times K_n
\end{equation}

dimana $X_L$ adalah batas dari outlier bawah dalam bentuk logaritma, sedangkan variabel lainnya sama dengan di atas.



## Landscape Page
Coba halaman landscape

\begin{landscape}

```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.height=5.2, fig.width=9.5, fig.align="center", fig.cap="petal versus septal width\\label{fig:figLand}"}

  plot(x=iris$Petal.Width, y=iris$Sepal.Width, xlab="petal", ylab="sepal")

```

\end{landscape}

